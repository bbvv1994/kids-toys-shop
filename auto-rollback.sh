#!/bin/bash

# üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ –∫–æ–º–º–∏—Ç—É b0b2411
# –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: bash auto-rollback.sh

set -e

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –∫ –∫–æ–º–º–∏—Ç—É b0b2411..."
echo "=================================================="

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /home/kids-toys/app

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ URL –Ω–∞ HTTPS
echo "üì° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS –¥–ª—è GitHub..."
git remote set-url origin https://github.com/bbvv1994/kids-toys-shop.git

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 stop kids-toys-backend 2>/dev/null || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –æ—Ç–∫–∞—Ç
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –æ—Ç–∫–∞—Ç..."
git fetch origin
git reset --hard b0b241184133ae08c5d3f01ba4816b3a4c0afdb1

echo "‚úÖ –û—Ç–∫–∞—Ç –∫ –∫–æ–º–º–∏—Ç—É b0b2411 –≤—ã–ø–æ–ª–Ω–µ–Ω!"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend
echo "üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
cd backend
npm install
npx prisma generate
npx prisma migrate deploy
cd ..

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend
echo "üé® –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
cd frontend
npm install
npm run build
cd ..

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 start ecosystem.config.js
pm2 save

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
sleep 5
pm2 status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
sleep 3
if curl -f -s http://localhost:5000/api/products > /dev/null; then
    echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
else
    echo "‚ö†Ô∏è API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs kids-toys-backend"
fi

echo "=================================================="
echo "üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üìä –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: /home/kids-toys/monitor.sh"

