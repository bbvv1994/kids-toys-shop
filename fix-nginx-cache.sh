#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è nginx
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏—Å—Ç–µ–º—ã

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è nginx..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root: sudo ./fix-nginx-cache.sh"
    exit 1
fi

# 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
log "üìã –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
if [ -f /etc/nginx/sites-available/kids-toys-shop ]; then
    cp /etc/nginx/sites-available/kids-toys-shop /etc/nginx/sites-available/kids-toys-shop.backup.$(date +%Y%m%d_%H%M%S)
    log "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞"
else
    log "‚ö†Ô∏è  –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π"
fi

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx
log "‚öôÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º..."

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
APP_DIR="/home/kids-toys/app"
if [ ! -d "$APP_DIR" ]; then
    APP_DIR="/root/kids-toys-shop"
fi

if [ ! -d "$APP_DIR" ]; then
    log "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å: $APP_DIR"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx
cat > /etc/nginx/sites-available/kids-toys-shop << EOF
server {
    listen 80;
    server_name _;
    
    # Frontend (—Å—Ç–∞—Ç–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã)
    location / {
        root $APP_DIR/frontend/build;
        try_files \$uri \$uri/ /index.html;
        
        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (JS, CSS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Vary Accept-Encoding;
            add_header ETag "";
            # –û—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å —Ö—ç—à–∞–º–∏ –≤ –∏–º–µ–Ω–∏
            if (\$uri ~* "\.[a-f0-9]{8,}\.(js|css)$") {
                expires max;
                add_header Cache-Control "public, immutable";
            }
        }
        
        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Ñ–∞–π–ª–æ–≤ - –ù–ï –∫—ç—à–∏—Ä—É–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header ETag "";
        }
        
        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–æ–≤ - –ù–ï –∫—ç—à–∏—Ä—É–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        location ~* \.json$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
        }
    }

    # Backend API
    location /api/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # –û—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # –¢–∞–π–º–∞—É—Ç—ã
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    location /uploads/ {
        proxy_pass http://localhost:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip —Å–∂–∞—Ç–∏–µ
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
}
EOF

log "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx —Å–æ–∑–¥–∞–Ω–∞"

# 3. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
log "üîó –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
ln -sf /etc/nginx/sites-available/kids-toys-shop /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
if nginx -t; then
    log "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    log "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx"
    exit 1
fi

# 5. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx
log "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx..."
systemctl reload nginx
log "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"

# 6. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
log "üßπ –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∫—ç—à–∞..."

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ nginx (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -d "/var/cache/nginx" ]; then
    rm -rf /var/cache/nginx/*
    log "‚úÖ –ö—ç—à nginx –æ—á–∏—â–µ–Ω"
fi

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ -d "/tmp" ]; then
    find /tmp -name "nginx*" -type f -delete 2>/dev/null || true
    log "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã nginx –æ—á–∏—â–µ–Ω—ã"
fi

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
log "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ nginx..."
if systemctl is-active --quiet nginx; then
    log "‚úÖ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    log "‚ùå Nginx –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    systemctl status nginx
    exit 1
fi

# 8. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
log "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞..."
cat > /usr/local/bin/clear-nginx-cache << 'EOF'
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ nginx

echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ nginx..."

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ nginx
if [ -d "/var/cache/nginx" ]; then
    rm -rf /var/cache/nginx/*
    echo "‚úÖ –ö—ç—à nginx –æ—á–∏—â–µ–Ω"
fi

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
find /tmp -name "nginx*" -type f -delete 2>/dev/null || true
echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx
systemctl reload nginx
echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"

echo "üéâ –ö—ç—à –æ—á–∏—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
EOF

chmod +x /usr/local/bin/clear-nginx-cache
log "‚úÖ –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ —Å–æ–∑–¥–∞–Ω: /usr/local/bin/clear-nginx-cache"

# 9. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
log "üìã –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π..."
cat > /root/nginx-cache-fix-instructions.md << 'EOF'
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è nginx - –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤**: JS, CSS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 1 –≥–æ–¥
2. **HTML —Ñ–∞–π–ª—ã**: –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
3. **JSON —Ñ–∞–π–ª—ã**: –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
4. **API –∑–∞–ø—Ä–æ—Å—ã**: –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
5. **Gzip —Å–∂–∞—Ç–∏–µ**: –í–∫–ª—é—á–µ–Ω–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞:
```bash
sudo clear-nginx-cache
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```bash
sudo nginx -t
```

### –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx:
```bash
sudo systemctl reload nginx
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ù–∞–∂–º–∏—Ç–µ Ctrl+F5 –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:

–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:
- /etc/nginx/sites-available/kids-toys-shop.backup.*

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è:

- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (JS, CSS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 1 –≥–æ–¥
- HTML –∏ JSON —Ñ–∞–π–ª—ã –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- API –∑–∞–ø—Ä–æ—Å—ã –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+F5 –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
EOF

log "‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã: /root/nginx-cache-fix-instructions.md"

# 10. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
log "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
systemctl status nginx --no-pager -l
echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:"
curl -I http://localhost/ 2>/dev/null | head -5 || echo "‚ö†Ô∏è  –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""
log "üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è nginx –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo "2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+F5 –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
echo "3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à: sudo clear-nginx-cache"
echo "4. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: cat /root/nginx-cache-fix-instructions.md"
echo ""



